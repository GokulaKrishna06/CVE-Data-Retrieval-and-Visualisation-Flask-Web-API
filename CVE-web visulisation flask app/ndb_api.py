from flask import Flask, redirect, render_template, request
from pymongo import MongoClient
from datetime import datetime, timedelta

app = Flask(__name__)

# MongoDB connection setup
client = MongoClient('localhost', 27017)
db = client['cve_api']
collection = db['cve_data']

@app.route("/cves/list")
def cve_list():
    page_size = int(request.args.get('pageSize', 10))
    page = int(request.args.get('page', 1))

    total_records = collection.count_documents({})
    total_pages = (total_records + page_size - 1) // page_size

    data = list(collection.find().skip((page - 1) * page_size).limit(page_size))

    return render_template("ndb_list.html", cves=data, page=page, pageSize=page_size, total_pages=total_pages,
                           total_records=total_records)

@app.route('/cves/<cveId>')
def get_cve(cveId):
    data = collection.find_one({"cve.id": cveId})

    if data:
        return render_template("ndb_details.html", cve=data['cve'])
    else:
        return "CVE not found", 404

@app.route("/cves/filter", methods=['GET', 'POST'])
def filter_cves():
    if request.method == 'POST':
        page_size = int(request.args.get('pageSize', 10))
        page = int(request.args.get('page', 1))
        total_records = collection.count_documents({})
        total_pages = (total_records + page_size - 1) // page_size
        
    

        # Retrieve form inputs
        cve_id = request.form['cveId']
        year = request.form['year']
        score = request.form['score']
        last_modified_days = request.form['lastModified']
        
        # Build the filter query
        filter_query = {}
        if cve_id:
            filter_query["cve.id"] = cve_id
        if year:
            filter_query["cve.published"] = {"$regex": f"^{year}"}
        if score:
            filter_query["$or"] = [
                {"cve.metrics.cvssMetricV2.cvssData.baseScore": score},
                {"cve.metrics.cvssMetricV3.cvssData.baseScore": score}
            ]
        if last_modified_days:
            last_modified_date = datetime.now() - timedelta(days=int(last_modified_days))
            filter_query["cve.lastModified"] = {"$gte": last_modified_date.strftime("%Y-%m-%d")}
        
        # Fetch filtered CVEs from MongoDB
        filtered_cves = list(collection.find(filter_query).skip((page - 1) * page_size).limit(page_size))
        return render_template("ndb_list.html", cves=filtered_cves,page=page, pageSize=page_size, total_pages=total_pages,
                           total_records=total_records)
    else:
        return render_template("filter.html")

# Update the index route to render the list of CVEs
@app.route('/')
def index():
    return redirect('/cves/list')

if __name__ == '__main__':
    app.run(debug=True)
